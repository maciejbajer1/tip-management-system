<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>BackupServiceTest.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#include &lt;QtTest&gt;
#include &lt;QDir&gt;
#include &lt;QFile&gt;
#include "BackupService.h"

class BackupServiceTest : public QObject {
    Q_OBJECT

private:
    QString testDbPath;
    QString backupDir;

<span style = "background-color:#dfd">    void createDummyDatabase() {
        QFile db(testDbPath);
        if (db.exists()) db.remove();
        QVERIFY(db.open(QIODevice::WriteOnly));
        db.write("Dummy database content");
        db.close();
    }</span>

private slots:
<span style = "background-color:#dfd">    void initTestCase() {
        QDir().mkpath("test_backups");
        backupDir = QDir::current().absoluteFilePath("test_backups");
        testDbPath = QDir::current().absoluteFilePath("test_database.db");
        createDummyDatabase();
    }</span>

<span style = "background-color:#dfd">    void cleanup() {
        QDir dir(backupDir);
        for (const QFileInfo&amp; f : dir.entryInfoList(QDir::Files)) {
            QFile::remove(f.absoluteFilePath());
        }
    }</span>

<span style = "background-color:#dfd">    void testCreateBackup_successful() {
        QString backupPath;
        BackupService service(testDbPath);
        QVERIFY(service.createBackup(backupDir, backupPath));
        QVERIFY(QFile::exists(backupPath));
    }</span>

<span style = "background-color:#dfd">    void testCreateBackup_emptyPath() {
        QString backupPath;
        BackupService service(testDbPath);
        QVERIFY(!service.createBackup("", backupPath));
    }</span>

<span style = "background-color:#dfd">    void testCreateBackup_generatesUniqueFile() {
        QString path1, path2;
        BackupService service(testDbPath);</span>

<span style = "background-color:#dfd">        QVERIFY(service.createBackup(backupDir, path1));
        QTest::qWait(1000);
        QVERIFY(service.createBackup(backupDir, path2));</span>

<span style = "background-color:#dfd">        QVERIFY(path1 != path2);
        QVERIFY(QFile::exists(path1));
        QVERIFY(QFile::exists(path2));
    }</span>

<span style = "background-color:#dfd">    void testBackupContentMatchesOriginal() {
        QString backupPath;
        BackupService service(testDbPath);
        QVERIFY(service.createBackup(backupDir, backupPath));</span>

<span style = "background-color:#dfd">        QFile orig(testDbPath);
        QFile copy(backupPath);
        QVERIFY(orig.open(QIODevice::ReadOnly));
        QVERIFY(copy.open(QIODevice::ReadOnly));
        QCOMPARE(orig.readAll(), copy.readAll());
    }</span>

<span style = "background-color:#dfd">    void testCreateBackup_invalidDestination() {
        QString backupPath;
        QString invalidDir = "C:/Windows/System32";
        BackupService service(testDbPath);
        QVERIFY(!service.createBackup(invalidDir, backupPath));
    }</span>

<span style = "background-color:#dfd">    void testCreateBackup_filenameFormat() {
        QString backupPath;
        BackupService service(testDbPath);
        QVERIFY(service.createBackup(backupDir, backupPath));</span>

<span style = "background-color:#dfd">        QFileInfo info(backupPath);
        QString name = info.fileName();</span>

<span style = "background-color:#dfd">        QRegularExpression regex(R"(backup_\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2}\.db)");
        QVERIFY(regex.match(name).hasMatch());
    }</span>

<span style = "background-color:#dfd">    void testCreateBackup_notEmptyFile() {
        QString path;
        BackupService service(testDbPath);
        QVERIFY(service.createBackup(backupDir, path));</span>

<span style = "background-color:#dfd">        QFileInfo info(path);
        QVERIFY(info.size() &gt; 0);
    }</span>
};

<span style = "background-color:#dfd">QTEST_MAIN(BackupServiceTest)</span>
#include "BackupServiceTest.moc"</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>